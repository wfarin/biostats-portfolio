---
title: "Analyse de survie avec R"
format: html
---

```{r setup, include=FALSE}

# Chargement des librairies
library(survival)
library(survminer)

```

\# Chargement des librairies library(survival) library(survminer)

```{r data, include=FALSE}
data(lung)
head(lung)

```

```{r surv, include=TRUE}

surv_obj <- Surv(time = lung$time, event = lung$status)
surv_obj[1:10]

```

```{r survfit, include=TRUE}

km_fit <- survfit(surv_obj ~ 1, data = lung)

ggsurvplot(
  km_fit,
  conf.int = TRUE,
  risk.table = TRUE,
  title = "Courbe de survie globale (Kaplan-Meier)",
  xlab = "Temps (jours)",
  ylab = "Probabilité de survie"
)

```

```{r ggplot, include=TRUE}

km_fit_group <- survfit(surv_obj ~ sex, data = lung)

ggsurvplot(
  km_fit_group,
  data = lung,
  pval = TRUE,
  conf.int = TRUE,
  risk.table = TRUE,
  legend.title = "Sexe",
  legend.labs = c("Homme", "Femme")
)


```

```{r coxph, include=TRUE}


cox_fit <- coxph(surv_obj ~ age + sex, data = lung)
summary(cox_fit)


```

## Sample Size Calculation

The objective of this exercise is to calculate the minimal sample size required to achieve **80% statistical power** with a **5% significance level (α = 0.05)**.

We assume two groups with survival medians reported in the literature:

-   **Group 1 (control):** median survival = 9 months

-   **Group 2 (treatment):** median survival = 13 months

The question is: *How many patients are required to detect a statistically significant difference in survival between the two groups?*

We use the `rpact` R package to perform the sample size calculation:

The assumed accrual time is set to 8 months and the followup to 10 months.

## SAMPLE SIZE WITH RPACT

```{r, warning=FALSE, message=FALSE}
library(rpact)
library(tidyverse)
library(gsDesign)
library(gt)

get_number <- function (x, element) {
  x[[element]]
}

sampleSize_rpact <- getSampleSizeSurvival(accrualTime = 8, followUpTime = 10,
                                          sided = 2, alpha = 0.10, beta = 0.2,
                                          median1 = 9, median2 = 13)
kable(sampleSize_rpact)
```

## POWER WITH RPACT

### Compute event rate first

```{r, warning=FALSE}
probEvent_rpact <- getEventProbabilities(lambda1 = log(2)/9, lambda2 = log(2)/14.5,
    time =18, 
    accrualTime = 8,
    maxNumberOfSubjects = 191
)
kable(probEvent_rpact)
```

### Compute power then

```{r, warning=FALSE}
n_event_rpact <- probEvent_rpact$cumulativeEventProbabilities * 191
design_rpact <- getDesignGroupSequential(kMax = 1,
    sided = 1, alpha = 0.05,
    typeOfDesign = "asOF"
)

powerResult_rpact <- getPowerSurvival(
    design = design_rpact, median1 = 9, median2 = 14.5,
    accrualTime = 8, 
    maxNumberOfSubjects = 191, maxNumberOfEvents = n_event_rpact
)
kable(powerResult_rpact)
```

### SAMPLE SIZE WITH gsDesign

```{r, warning=FALSE}

r <- 1 # Experimental/control randomization ratio
alpha <- 0.05 # 1-sided Type I error
beta <- 0.2 # Type II error (1 - power)
hr <- 14.5/9 # Hazard ratio (experimental / control)
controlMedian <- 9
dropoutRate <- 0 # Exponential dropout rate per time unit
enrollDuration <- 8
minfup <- 10 # Minimum follow-up
Nlf <- nSurvival(sided = 1,
  lambda1 = log(2) / 9, lambda2 = log(2) / 14.5,
  eta = dropoutRate,
  Tr = enrollDuration,
  Ts = 18,
  ratio = r,
  alpha = alpha,
  beta = beta
)
cat(paste("Sample size: ", ceiling(Nlf$n), "Events: ", ceiling(Nlf$nEvents), "\n"))
```
